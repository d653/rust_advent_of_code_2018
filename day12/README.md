The second part can be done fast by noticing that at some point the next state is equal to the previous state, moved by some offset.
